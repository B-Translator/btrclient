<?php
/**
 * @file
 * Module file for btrVocabulary.
 */

module_load_include('inc', 'btrVocabulary', 'form_build');
module_load_include('inc', 'btrVocabulary', 'form_submit');

/**
 * Implements hook_menu().
 */
function btrVocabulary_menu() {
  $items['vocabulary'] = array(
    'title'           => 'Vocabulary',
    'description'     => 'Lookup vocabulary items.',
    'page callback'   => 'btrVocabulary_page',
    //'file'            => 'form.inc',
    'access callback' => TRUE,
  );
  return $items;
}

/**
 * Implements hook_menu_link_alter().
 */
function btrVocabulary_menu_link_alter(&$item) {
  // Open vocabulary on a new tab.
  if ($item['link_path'] == 'vocabulary') {
    $item['options']['attributes']['target'] = '_blank';
  }
}

/**
 * Implements hook_theme().
 */
function btrVocabulary_theme($existing, $type, $theme, $path) {
  return array(
    'btrVocabulary_table' => array(
      'render element' => 'element',
    ),
  );
}

/**
 * Menu callback: vocabulary.
 */
function btrVocabulary_page($vocabulary = NULL, $term = NULL) {
  if ($vocabulary == NULL) {
    $lng = bcl::get_translation_lng();
    $vocabulary = 'ICT_' . $lng;
    drupal_goto("vocabulary/$vocabulary");
  }

  // Check whether this is a redirect after login,
  // and if yes call the submit function again.
  bcl::form_resubmit();

  // Set the page title.
  drupal_set_title(t('Vocabulary: !vocabulary',
      array('!vocabulary' => $vocabulary),
      array('context' => 'set the page title')));

  // Add the CSS and JS files.
  drupal_add_css(drupal_get_path('module', 'btrClient') . '/editor/editor.css');
  drupal_add_js(drupal_get_path('module', 'btrClient') . '/editor/jquery.worddiff.js');
  drupal_add_js(drupal_get_path('module', 'btrClient') . '/editor/editor.js');

  // Add RTL style if the current language's direction is RTL.
  $languages = bcl::get_languages();
  list($_, $lng) = explode('_', $vocabulary, 2);
  if ($languages[$lng]['direction'] == LANGUAGE_RTL) {
    drupal_add_css(drupal_get_path('module', 'btrClient') . '/editor-rtl.css');
  }

  // Add the stylesheet of btrVocabulary.
  $css_file = drupal_get_path('module', 'btrVocabulary');
  $css_file .= (bcl::inside_iframe() ?
               '/style-iframe.css' :
               '/style.css');
  drupal_add_css($css_file);

  // Build and return the output.
  $output = drupal_get_form('btrVocabulary_form', $vocabulary, $term);
  return $output;
}
